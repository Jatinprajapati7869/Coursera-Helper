__version__ = "1.0"

import sys, requests
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QWidget, QLabel, QLineEdit, QPushButton, QRadioButton,
    QComboBox, QFileDialog, QMessageBox, QVBoxLayout, QHBoxLayout, QAction, QGroupBox, QTextBrowser, QProgressBar, QTextEdit
)
from PyQt5.QtGui import QIcon, QCursor
from PyQt5.QtCore import Qt, pyqtSignal, QThread, QObject

from utils import process_notification_html
import general
from coursera_dl import main_f

import livedb
from threading import Thread
import webbrowser
from os import path


class DownloadWorker(QObject):
    """Worker thread for running downloads"""
    progress_update = pyqtSignal(str)
    finished = pyqtSignal()
    error = pyqtSignal(str)
    
    def __init__(self, cmd):
        super().__init__()
        self.cmd = cmd
    
    def run(self):
        try:
            from coursera_dl import main_f
            main_f(self.cmd)
            self.finished.emit()
        except Exception as e:
            self.error.emit(str(e))


class MainWindow(QMainWindow):
    
    # Signals
    show_update_message = pyqtSignal(str, str, str)
    show_notification_signal = pyqtSignal(str)
    download_progress = pyqtSignal(str)

    def __init__(self):
        super().__init__()
        self.setWindowTitle("Coursera Helper v1.0")
        self.setMinimumSize(650, 600)
        self.setWindowFlags(self.windowFlags() & ~Qt.WindowMaximizeButtonHint)
        icon_path = path.abspath(path.join(path.dirname(__file__), 'icon/icon.ico'))
        self.setWindowIcon(QIcon(icon_path))

        self.notification = ""
        self.download_thread = None
        self.download_worker = None
        self.is_downloading = False
        self.sllangschoices = general.LANG_NAME_TO_CODE_MAPPING
        self.allowed_browsers = general.ALLOWED_BROWSERS

        from localdb import SimpleDB
        self.localdb  = SimpleDB('data.bin')
        self.argdict = self.localdb.get_full_db()['argdict']
        
        # Apply modern dark theme
        self.apply_dark_theme()
        
        self.initUI()

        # signals
        self.show_update_message.connect(self.display_update_message)
        self.show_notification_signal.connect(self.show_notification)

        # PRIVACY: Remote database connection disabled - no tracking/telemetry
        # Thread(target=self.connect_to_db, daemon=True).start()
        
        # Show disclaimer on first startup
        self.show_startup_disclaimer()

    def apply_dark_theme(self):
        """Apply glassmorphism dark theme with blur effects"""
        QApplication.setStyle('Fusion')
        self.setStyleSheet("""
            QMainWindow {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                    stop:0 #1a1a2e, stop:1 #16213e);
            }
            QWidget {
                background-color: transparent;
                color: #e0e0e0;
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 13px;
            }
            QLabel {
                color: #e0e0e0;
                font-size: 13px;
                background: transparent;
            }
            QLineEdit {
                padding: 12px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(45, 45, 45, 0.6);
                color: #ffffff;
                font-size: 13px;
            }
            QLineEdit:focus {
                border: 1px solid rgba(33, 150, 243, 0.8);
                background: rgba(45, 45, 45, 0.8);
            }
            QComboBox {
                padding: 10px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(45, 45, 45, 0.6);
                color: #ffffff;
                font-size: 13px;
            }
            QComboBox::drop-down {
                border: none;
                width: 30px;
            }
            QComboBox::down-arrow {
                width: 12px;
                height: 12px;
            }
            QPushButton {
                padding: 14px 28px;
                border-radius: 10px;
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #2196F3, stop:1 #21CBF3);
                color: white;
                font-weight: bold;
                font-size: 14px;
                border: none;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #1976D2, stop:1 #1CB5E0);
            }
            QPushButton:pressed {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #0D47A1, stop:1 #0D7EA1);
            }
            QPushButton:disabled {
                background: rgba(100, 100, 100, 0.4);
                color: rgba(255, 255, 255, 0.4);
            }
            QPushButton#selectFolderBtn {
                background: rgba(66, 66, 66, 0.6);
                padding: 10px 20px;
            }
            QPushButton#selectFolderBtn:hover {
                background: rgba(97, 97, 97, 0.7);
            }
            QPushButton#cancelBtn {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #f44336, stop:1 #e91e63);
            }
            QPushButton#cancelBtn:hover {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #d32f2f, stop:1 #c2185b);
            }
            QRadioButton {
                color: #e0e0e0;
                spacing: 10px;
                background: transparent;
            }
            QRadioButton::indicator {
                width: 20px;
                height: 20px;
            }
            QRadioButton::indicator:unchecked {
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 10px;
                background: rgba(45, 45, 45, 0.6);
            }
            QRadioButton::indicator:checked {
                border: 2px solid #2196F3;
                border-radius: 10px;
                background: qradialgradient(cx:0.5, cy:0.5, radius:0.5,
                    fx:0.5, fy:0.5, stop:0 #2196F3, stop:1 #1976D2);
            }
            QGroupBox {
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                margin-top: 14px;
                padding-top: 20px;
                padding-bottom: 15px;
                background: rgba(45, 45, 45, 0.4);
                font-weight: bold;
                color: #2196F3;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 15px;
                padding: 0 10px;
                background: transparent;
            }
            QProgressBar {
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                text-align: center;
                background: rgba(30, 30, 30, 0.6);
                color: white;
                font-weight: bold;
            }
            QProgressBar::chunk {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #2196F3, stop:1 #21CBF3);
                border-radius: 7px;
            }
            QTextEdit, QTextBrowser {
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                background: rgba(30, 30, 30, 0.6);
                color: #e0e0e0;
                padding: 10px;
                font-family: 'Consolas', 'Courier New', monospace;
                font-size: 11px;
            }
            QMenuBar {
                background: rgba(45, 45, 45, 0.8);
                color: #e0e0e0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            QMenuBar::item:selected {
                background: rgba(33, 150, 243, 0.7);
            }
            QMenu {
                background: rgba(45, 45, 45, 0.95);
                color: #e0e0e0;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            QMenu::item:selected {
                background: rgba(33, 150, 243, 0.7);
            }
        """)

    def initUI(self):
        # Menu
        menubar = self.menuBar()
        menu = menubar.addMenu("Menu")
        about_action = QAction("About", self)
        about_action.triggered.connect(self.show_about)
        help_action = QAction("Help", self)
        help_action.triggered.connect(self.show_help)
        menu.addAction(about_action)
        menu.addAction(help_action)

        # Central widget
        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout()
        central.setLayout(layout)
        layout.setSpacing(15)
        layout.setContentsMargins(20, 20, 20, 20)

        # Header with title
        title = QLabel("Coursera Helper")
        title.setStyleSheet("font-size: 20px; font-weight: bold; color: #2196F3; padding: 10px;")
        title.setAlignment(Qt.AlignCenter)
        layout.addWidget(title)

        # Info message
        info = QLabel("Log in to coursera.org in your browser before downloading courses you're enrolled in.")
        info.setWordWrap(True)
        info.setAlignment(Qt.AlignCenter)
        info.setStyleSheet("color: #aaa; font-size: 12px; padding-bottom: 10px;")
        layout.addWidget(info)

        # Course Information Group
        course_group = QGroupBox("Course Information")
        course_layout = QVBoxLayout()
        course_group.setLayout(course_layout)
        
        # Course URL
        url_layout = QVBoxLayout()
        url_layout.setSpacing(6)
        url_label = QLabel("Course URL:")
        self.classname_edit = QLineEdit(self.localdb.read('argdict')['classname'])
        self.classname_edit.setPlaceholderText("https://www.coursera.org/learn/course-name")
        url_layout.addWidget(url_label)
        url_layout.addWidget(self.classname_edit)
        course_layout.addLayout(url_layout)
        
        # Browser selection
        browser_layout = QVBoxLayout()
        browser_layout.setSpacing(6)
        browser_label = QLabel("Browser (where you're logged in):")
        self.browser_combo = QComboBox()
        self.browser_combo.addItems(self.allowed_browsers)
        default_browser = self.localdb.read('browser')
        if default_browser in self.allowed_browsers:
            self.browser_combo.setCurrentText(default_browser)
        browser_layout.addWidget(browser_label)
        browser_layout.addWidget(self.browser_combo)
        course_layout.addLayout(browser_layout)
        
        layout.addWidget(course_group)

        # Settings Group
        settings_group = QGroupBox("Download Settings")
        settings_layout = QVBoxLayout()
        settings_group.setLayout(settings_layout)
        
        # Download folder
        folder_layout = QVBoxLayout()
        folder_layout.setSpacing(6)
        folder_label = QLabel("Download Folder:")
        self.path_btn = QPushButton("Select Folder")
        self.path_btn.setObjectName("selectFolderBtn")
        self.path_btn.clicked.connect(self.getPath)
        self.path_label = QLabel(self.localdb.read('argdict')['path'] or "No folder selected")
        self.path_label.setStyleSheet("color: #888; font-size: 12px; padding: 5px;")
        folder_layout.addWidget(folder_label)
        folder_layout.addWidget(self.path_btn)
        folder_layout.addWidget(self.path_label)
        settings_layout.addLayout(folder_layout)
        
        # Video resolution
        res_layout = QVBoxLayout()
        res_layout.setSpacing(6)
        res_label = QLabel("Video Quality:")
        res_buttons = QHBoxLayout()
        self.res_720 = QRadioButton("HD (720p)")
        self.res_540 = QRadioButton("SD (540p)")
        self.res_360 = QRadioButton("Low (360p)")
        res_buttons.addWidget(self.res_720)
        res_buttons.addWidget(self.res_540)
        res_buttons.addWidget(self.res_360)
        res_buttons.addStretch()
        
        # Set checked
        if self.localdb.read('argdict')['video_resolution'] == '540p':
            self.res_540.setChecked(True)
        elif self.localdb.read('argdict')['video_resolution'] == '360p':
            self.res_360.setChecked(True)
        else:
            self.res_720.setChecked(True)
        
        res_layout.addWidget(res_label)
        res_layout.addLayout(res_buttons)
        settings_layout.addLayout(res_layout)
        
        # Subtitle language
        subtitle_layout = QVBoxLayout()
        subtitle_layout.setSpacing(6)
        subtitle_label = QLabel("Subtitle Language:")
        self.sl_combo = QComboBox()
        self.sl_combo.addItems(sorted(self.sllangschoices.keys()))
        key = next((k for k, v in self.sllangschoices.items() if v == self.localdb.read('argdict')['sl']), None)
        self.sl_combo.setCurrentText(key if key else 'English')
        subtitle_layout.addWidget(subtitle_label)
        subtitle_layout.addWidget(self.sl_combo)
        settings_layout.addLayout(subtitle_layout)
        
        layout.addWidget(settings_group)

        # Notification area
        self.notification_area = QTextBrowser()
        self.notification_area.setMaximumHeight(80)
        self.notification_area.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.notification_area.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        self.notification_area.setVisible(False)
        layout.addWidget(self.notification_area)

        # Progress Panel (initially hidden)
        self.progress_panel = QGroupBox("Download Progress")
        self.progress_panel.setVisible(False)
        progress_layout = QVBoxLayout()
        self.progress_panel.setLayout(progress_layout)
        
        # Current course label
        self.current_course_label = QLabel("Preparing download...")
        self.current_course_label.setStyleSheet("font-size: 14px; font-weight: bold; color: #2196F3;")
        progress_layout.addWidget(self.current_course_label)
        
        # Status label
        self.status_label = QLabel("Initializing...")
        self.status_label.setStyleSheet("color: #aaa; font-size: 12px;")
        progress_layout.addWidget(self.status_label)
        
        # Progress bar
        self.progress_bar = QProgressBar()
        self.progress_bar.setRange(0, 0)  # Indeterminate mode
        self.progress_bar.setTextVisible(False)
        self.progress_bar.setMinimumHeight(8)
        progress_layout.addWidget(self.progress_bar)
        
        # Detailed log (collapsible)
        self.progress_log = QTextEdit()
        self.progress_log.setReadOnly(True)
        self.progress_log.setMaximumHeight(150)
        progress_layout.addWidget(self.progress_log)
        
        layout.addWidget(self.progress_panel)

        # Add stretch to push download button to bottom
        layout.addStretch(1)

        # Download Button Area
        button_layout = QHBoxLayout()
        button_layout.addStretch(1)
        
        # Download/Cancel Button
        self.download_btn = QPushButton("Start Download")
        self.download_btn.setMinimumSize(200, 50)
        self.download_btn.setCursor(QCursor(Qt.PointingHandCursor))
        self.download_btn.clicked.connect(self.downloadBtnHandler)
        button_layout.addWidget(self.download_btn)
        
        # Cancel button (hidden initially)
        self.cancel_btn = QPushButton("Cancel")
        self.cancel_btn.setObjectName("cancelBtn")
        self.cancel_btn.setMinimumSize(120, 50)
        self.cancel_btn.setCursor(QCursor(Qt.PointingHandCursor))
        self.cancel_btn.clicked.connect(self.cancelDownload)
        self.cancel_btn.setVisible(False)
        button_layout.addWidget(self.cancel_btn)
        
        button_layout.addStretch(1)
        layout.addLayout(button_layout)

        # Footer
        self.footer_msg = '<a href="https://coursera-downloader.rf.gd/" style="color:#2196F3; text-decoration: none;">coursera-downloader.rf.gd</a>'
        self.footer_label = QLabel(self.footer_msg)
        self.footer_label.setOpenExternalLinks(True)
        self.footer_label.setAlignment(Qt.AlignCenter)
        self.footer_label.setStyleSheet("padding: 10px; font-size: 11px; background: transparent;")
        layout.addWidget(self.footer_label)

    # remote database connection and update check
    def connect_to_db(self):
        """
        PRIVACY: This method previously connected to Firebase for tracking.
        All tracking functionality has been disabled.
        """
        pass

    def display_update_message(self, latest_version, latest_version_build_url=None, update_msg=None):
        msg_box = QMessageBox(self)
        
        msg_box.setWindowTitle("Update Available")
        msg_box.setText(
            f"A new version ({latest_version}) is available. Please update the app."
            f"\n\n{f'Update log: {update_msg}' if update_msg else ''}"
        )

        update_btn = msg_box.addButton("Update", QMessageBox.AcceptRole)
        dont_show_again_btn = msg_box.addButton("Don't show again", QMessageBox.DestructiveRole)
        later_btn = msg_box.addButton("Later", QMessageBox.RejectRole)
        
        dlg.setTextInteractionFlags(Qt.TextSelectableByMouse | Qt.TextSelectableByKeyboard)
        dlg.setText(about_text)
        dlg.setStandardButtons(QMessageBox.Ok)
        dlg.exec_()

    def show_help(self):
        from gui_components.help_text import get_help_text
        help_text = get_help_text()

        dlg = QMessageBox(self)
        dlg.setWindowTitle("Help - Coursera Helper v1.0")
        dlg.setTextFormat(Qt.RichText)
        dlg.setTextInteractionFlags(Qt.TextSelectableByMouse | Qt.TextSelectableByKeyboard)
        dlg.setText(help_text)
        dlg.setStandardButtons(QMessageBox.Ok)
        dlg.exec_()

    def show_startup_disclaimer(self):
        """Show important disclaimer on startup"""
        disclaimer = QMessageBox(self)
        disclaimer.setWindowTitle("Important Notice - Responsible Use")
        disclaimer.setIcon(QMessageBox.Warning)
        
        text = """<html><head/><body>
        <h3 style='color: #2196F3;'>Coursera Helper - Responsible Use Policy</h3>
        
        <p><b>IMPORTANT DISCLAIMER</b></p>
        
        <p>This tool is designed to help you access course materials for <b>personal learning purposes only</b>.</p>
        
        <ul>
        <li> We respect <b> Courseras Terms & Conditions </b></li>
        <li> Use Courseras <b>default download options</b> when available</li>
        <li> <b>Bulk downloading may lead to account suspension</b></li>
        <li> Please <b>respect creators hard work</b></li>
        </ul>
        
        <p style='font-size: 14px; font-style: italic; color: #f44336; font-weight: bold;'>
        "With great power comes great responsibility." - Uncle Ben
        </p>
        
        <p><b> DO NOT:</b></p>
        <ul>
        <li>Share downloaded content publicly</li>
        <li>Redistribute materials to others</li>
        <li>Use for commercial purposes</li>
        <li>Violate copyright laws</li>
        </ul>
        
        <p><b> DO:</b></p>
        <ul>
        <li>Download for personal study only</li>
        <li>Take breaks between module downloads</li>
        <li>Support creators by enrolling legitimately</li>
        </ul>
        
        <p style='color: #888; font-size: 11px;'>
        <i>The developer is not responsible for misuse of this tool.<br>
        By clicking 'I Understand', you agree to use this tool responsibly and ethically.</i>
        </p>
        </body></html>"""
        
        disclaimer.setText(text)
        disclaimer.setTextFormat(Qt.RichText)
        
        understand_btn = disclaimer.addButton("I Understand & Agree", QMessageBox.AcceptRole)
        cancel_btn = disclaimer.addButton("Exit", QMessageBox.RejectRole)
        
        disclaimer.exec_()
        
        if disclaimer.clickedButton() == cancel_btn:
            sys.exit(0)
    
    def show_completion_disclaimer(self):
        """Show disclaimer after download completes"""
        dlg = QMessageBox(self)
        dlg.setWindowTitle("Download Complete - Remember")
        dlg.setIcon(QMessageBox.Information)
        
        text = """<html><head/><body>
        <h3 style='color: #4CAF50;'> Download Complete!</h3>
        
        <p><b> Final Reminder:</b></p>
        
        <p style='font-size: 13px;'>
        The materials youve downloaded are for <b>your personal learning only</b>.
        </p>
        
        <ul>
        <li> <b>DO NOT</b> share these files with others</li>
        <li> <b>DO NOT</b> upload to file-sharing platforms</li>
        <li> <b>DO NOT</b> redistribute in any form</li>
        <li> <b>DO</b> use them for your own education</li>
        </ul>
        
        <p style='color: #f44336; font-weight: bold;'>
        Respect the creators. Support education. Learn responsibly.
        </p>
        
        <p style='color: #888; font-size: 11px;'>
        <i>Thank you for using Coursera Helper ethically! </i>
        </p>
        </body></html>"""
        
        dlg.setText(text)
        dlg.setTextFormat(Qt.RichText)
        dlg.setStandardButtons(QMessageBox.Ok)
        dlg.exec_()

    # Button handlers
    def downloadBtnHandler(self):
        # load cauth code automatically and store it in inputvardict
        browser = self.browser_combo.currentText()
        cauth = general.loadcauth('coursera.org', browser)
        if cauth == "":
            QMessageBox.warning(self, "Error", "Could not load authentication from the browser.\nPlease make sure you are logged in on coursera.org in the selected browser and running the application as administrator.")
            return
        
        self.localdb.update('argdict.ca', cauth)

        # Get values from widgets
        self.localdb.update('browser', browser)
        self.localdb.update('argdict.classname', self.classname_edit.text())
        self.localdb.update('argdict.path', self.path_label.text())
        if self.res_720.isChecked():
            self.localdb.update('argdict.video_resolution', '720p')
        elif self.res_540.isChecked():
            self.localdb.update('argdict.video_resolution', '540p')
        else:
            self.localdb.update('argdict.video_resolution', '360p')
        self.localdb.update('argdict.sl', self.sl_combo.currentText())

        # check if path is valid
        if self.localdb.read('argdict')['path'] == '':
            QMessageBox.warning(self, "Error", "NO FOLDER SPECIFIED. PLEASE SELECT A FOLDER")
            return

        # make argdict from inputvarlist
        self.argdict = {}
        for key, value in self.localdb.get_full_db()['argdict'].items():
            if key == 'classname':
                courseurl = self.localdb.read('argdict')['classname']
                cname = general.urltoclassname(courseurl)
                if cname == "":
                    QMessageBox.warning(self, "Error", "INVALID COURSE NAME/ HOME PAGE URL")
                    return
                self.argdict[key] = cname
                continue
            if key == 'sl':
                langcode = self.sllangschoices[self.localdb.read('argdict')['sl']]
                if langcode == '':
                    self.argdict['ignore-formats'] = "srt"
                    self.argdict[key] = 'en'
                    continue
                else:
                    self.argdict[key] = langcode
                    continue
            self.argdict[key] = value

        # save the argdict to data.bin
        self.localdb.update('argdict', self.argdict)

        # create command from argumentdict
        cmd = []
        self.argdict = general.move_to_first(self.argdict, 'ca')
        for item in self.argdict.items():
            if (item[0] == 'video_resolution') or (item[0] == 'path'):
                flag = '--' + item[0]
            else:
                flag = '-' + item[0]
            flag = flag.replace('_', '-')
            if not 'classname' in flag:
                cmd.append(flag)
            cmd.append(item[1])

        cmd.append('--download-quizzes')
        cmd.append('--download-notebooks')
        cmd.append('--disable-url-skipping')
        cmd.append('--unrestricted-filenames')
        cmd.append('--combined-section-lectures-nums')
        cmd.append('--jobs')
        cmd.append('1')

        try:
            main_f(cmd)
            # Show completion disclaimer
            self.show_completion_disclaimer()
        except KeyboardInterrupt:
            QMessageBox.information(self, "Stopped", "DOWNLOAD STOPPED, YOU CAN RESUME YOUR DOWNLOAD LATER")
        except requests.exceptions.ConnectionError:
            QMessageBox.warning(self, "Connection Error", "FAILED TO CONNECT TO COURSES SERVER. PLEASE CHECK YOUR INTERNET CONNECTION AND TRY AGAIN.")
        except requests.exceptions.HTTPError as e:
            QMessageBox.warning(self, "HTTP Error", f"HTTP ERROR: {e}\nMAKE SURE YOU ARE LOGGED IN ON coursera.org ON A BROWSER AND YOU ARE ENROLLED INTO THE COURSE")
        except requests.exceptions.SSLError as e:
            QMessageBox.warning(self, "SSL Error", f"SSL ERROR: {e}")
        except Exception as e:
            QMessageBox.warning(self, "Error", f"SOMETHING WENT WRONG, PLEASE TRY AGAIN\n{e}")

    def cancelDownload(self):
        """Cancel the ongoing download"""
        if self.download_thread and self.download_thread.isRunning():
            self.download_thread.terminate()
            self.download_thread.wait()
        
        self.is_downloading = False
        self.progress_panel.setVisible(False)
        self.download_btn.setEnabled(True)
        self.cancel_btn.setVisible(False)
        self.download_btn.setText("Start Download")
        self.status_label.setText("Download cancelled")
        QMessageBox.information(self, "Cancelled", "Download has been cancelled.")

    def getPath(self):
        dir = QFileDialog.getExistingDirectory(self, "Select Download Folder", "")
        self.path_label.setText(dir)


if __name__ == "__main__":
    # FIX: Add these two lines to enable High DPI scaling
    QApplication.setAttribute(Qt.AA_EnableHighDpiScaling, True)
    QApplication.setAttribute(Qt.AA_UseHighDpiPixmaps, True)

    app = QApplication(sys.argv)
    win = MainWindow()
    win.show()
    sys.exit(app.exec_())